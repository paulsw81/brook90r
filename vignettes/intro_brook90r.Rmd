---
title: "Intoduction to brook90r"
author: "Paul Schmidt-Walter"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: vignette_brook90r.bib
vignette: >
  %\VignetteIndexEntry{Introduction to brook90r}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette gives a brief introduction to the usage of the *brook90r* R-package. The package serves as an interface between R and the executable code of the hydrological model LWF-BROOK90 [@hammel_charakterisierung_2001]. The executable file *b90.exe* is available at the [Bavarian State Institute of Forestry](https://www.lwf.bayern.de/boden-klima/wasserhaushalt/index.php). The functionnality is presented on a working example.

***

# Introduction

LWF-BROOK90 [@hammel_charakterisierung_2001] is a hydrological model to calculate daily evaporation (transpiration, interception, and soil evaporation) and soil water fluxes, along with soil water contents and pressure heads of a soil profile covered with vegetation. It is an upgraded version of the original BROOK90 hydrological model [@federer_sensitivity_2003; @federer_brook_2002], featuring additional parameterizations of the soil water retention and conductivity functions (@van_genuchten_closed-form_1980; @mualem_new_1976), and the option to take interannual and intraannual variations of aboveground vegetation characteristics into account when calculating evapotranspiration. Originally, LWF-BROOK90 is delivered and used together with an MS ACCESS GUI to organize model input, select model options and parameters and run the model. The basic funcitonality of the GUI is covered by *brook90r*, and with one function call it will:

* write input files from climate driving data, model control options and parameters,
* start the commandline-tool LWF-BROOK90,
* read and return the created output files.

The model control options thereby let you select different functions for defining aboveground stand dynamics, phenology, and root length density depth distributions. Additionally, a set of pedotransfer functions is provided to derive hydraulic parameters from soil physical properties.

# Installation

Before installing the *brook90r* R-package, be sure to to download and install the following packages, as *brook90r* depends on them:

```{r, eval=FALSE}
install.packages("vegperiod", repos="https://www.nw-fva.de/r-pkgs")
install.packages("data.table", repos="https://cran.rstudio.com/")
```
As *brook90r* is not available on CRAN, you have to install it directly from Github, using the *devtools*-package:
```{r, eval = F}
devtools::install_github("pschmidtwalter/brook90r")
```
Now load the *brook90r* package:
```{r}
library(brook90r)
```

# Data
In this vignette, we will use meteorological and soil data from the longterm monitoring beech forest site SLB1 in the Solling mountains, Germany. The datasets are directly available after loading the package, use ?soil_slb1 and ?meteo_slb1 to see the meaning of the variables and their units.

# Basics
The central function to run LWF-BROOK90 from within R is *Run.B90()*. Before we use it, we need to set up the required input objects that are passed as arguments. Aside from meteorological and soil data, we need to define lists containing the model control options and model parameters. The model control list contains basic information about the simulation (e.g. the start and end dates of the simulation, the phenology model, root length density depth distribution model, etc). The parameter list contains about 100 parameters, of which most are required to run the model, but some only take effect if certain model control options are chosen. Two functions are defined in *brook90r* that can be used to generate default model options and parameters:
```{r}
options.b90 <- MakeIniControl.B90()
param.b90 <- MakeParam.B90()
```
The created lists can be easily manipulated by reference, and you can use the help pages of the functions to look up the meanings of the various options and parameters. The meaning and context of most parameters can also be looked up in the documentation of the original Brook90 model version on [Tony Federer's webpages](http://www.ecoshift.net/brook/b90doc.html), which is always a recommended source of information for working with any Brook90 version.

We want to run LWF-Brook90 using the sample data from the Solling site and we need to prepare the datasets for LWF-Brook90. *soil_slb1* contains soil physical data, but not yet the hydraulic parameters that LWF-BROOK90 requires. Fortunately, *brook90r* comes with a set of pedotransfer functions to derive the Mualem/van Genuchten parameters of the soil water retention and hydraulic conductivity functions. Here we use the equations of Puhlmann & von Wilpert (-@puhlmann_test_2011) and create a data.frame containing the required MvG-parameters along with the soil physical data:
```{r}
soil <- cbind(soil_slb1, hydpar_puh2(clay = soil_slb1$clay,
                                     silt = soil_slb1$silt,
                                     sand = soil_slb1$sand,
                                     bd = soil_slb1$bd,
                                     oc.pct = soil_slb1$c_org))
```
The values of *globrad* in *meteo_slb1* contains daily mean solar radiation in W/m², that we need to convert into the daily sum of global radiation in MJ/², as required by LWF-BROOK90:

```{r}
meteo_slb1$globrad <- meteo_slb1$globrad*0.0864
```

Now we are ready to start the simulation using the central function *Run.B90()* and save the returned simulation results in an object: 

```{r}
b90.results.slb1 <- Run.B90(directory = "example_run_b90",
                            param = param.b90,
                            inicontrol = options.b90,
                            soil = soil,
                            climate = meteo_slb1,
                            path_b90.exe = "b90.exe")
```
*Run.B90* thereby creates the "in" and "out" folders within the "directroy" folder, derives the daily stand properties (densef, height, lai, sai, age) and writes climate, vegetation properties and parameters to the climate.in and param.in files in the "in" folder. It then starts the commandline tool "b90.exe" which stores its output as .asc-files in the "out"-folder, and then returns the contents of the ou 





# References


